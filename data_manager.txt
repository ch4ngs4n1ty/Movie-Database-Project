"""
data_manager.py

This script contains functions to manage and modify database data.
It uses the Faker library to generate fake data and updates the database.

Type annotations are minimally used. It is just for clarity, it doesn't affect the code.

https://www.psycopg.org/docs/cursor.html - example for execute many
https://www.psycopg.org/docs/usage.html - example for execute

Steps to use this code:
(1) Make a new file called data_manager.py
(2) Copy and paste this txt file into data_manager.py
(3) Read the TODO comments
(4) Run data_manager.py to make changes to the database like:
    python data_manager.py
    or
    python3 data_manager.py
    or
    something else
"""

import os
import psycopg
from sshtunnel import SSHTunnelForwarder
from dotenv import load_dotenv

from faker import Faker
import random

msg1 = '✅ Running modify_database..........................[1/3]'
msg2 = '✅ Data created.....................................[2/3]'
msg3 = '✅ Update successful................................[3/3]'

def create_data(curs, conn, quantity: int) -> list[tuple[str, str]]:
    """
    Generates fake data.

    This function uses the Faker library to generate fake stuff. You
    don't need to use it. Random library also works for time related data.

    Args:
        curs: The database cursor object used to execute SQL queries.
        conn: The database connection object.
        quantity: The number of fake data to generate.

    Returns:
        A list of tuples, where each tuple contains the fake data. The
        should match the sql statement in modify_database function.
    """
    # Create fake object, we access specific methods to obtain fake data
    fake = Faker()

    tuples = []
    for i in range(1, quantity + 1):
        ######################################################### 
        ################ beginning of customize area ############ 
        ######################################################### 

        # TODO: This is example code that generates fake data

        # curs.execute('SELECT firstname FROM users WHERE userid = %s', (f'u{i}',))
        # a = curs.fetchone()[0]
        # email = a + f'{random.randint(1,1000)}'+ random.choice(['@gmail.com', '@yahoo.com', '@outlook.com', '@hotmail.com'])
        # t = (email, f'u{i}')

        ######################################################### 
        #################### end of customize area ##############
        ######################################################### 
        tuples.append(t) # TODO: t is the tuple, so set t = ('something', 'something') like the line above. No need to change this line
    return tuples

def modify_database(curs: psycopg.Cursor, conn: psycopg.Connection) -> None:
    """
    Modifies the database by inserting generated fake data created by create_data().

    It uses the SQL statement to make changes to the database. Modify it accordingly
    depending on which table you would like to insert to.

    Args:
        curs (psycopg.Cursor): The database cursor object used to execute SQL queries.
        conn (psycopg.Connection): The database connection object.

    Returns:
        None
    """
    print(msg1)

    # TODO: Modify the entires to the size of the table you are iterating through
    entries = 5000

    tuples = create_data(curs, conn, entries)
    print(msg2)

    # TODO: Change the sql statement depending on what you want to do
    sql_statement = 'INSERT INTO email (email, userid) VALUES (%s, %s)'

    try:
        curs.executemany(sql_statement, tuples)
        conn.commit()
        print(msg3)
    except Exception as e:
        conn.rollback()
        print(f'❌ Error updating database: {e}')

def main():
    load_dotenv()

    username = os.getenv("RIT_USERNAME")
    password = os.getenv("RIT_PASSWORD")
    dbName = 'p32001_23'

    try:
        with SSHTunnelForwarder(('starbug.cs.rit.edu', 22),
                                ssh_username=username,
                                ssh_password=password,
                                remote_bind_address=('127.0.0.1', 5432)) as server:
            server.start()
            print("SSH tunnel established")
            params = {
                'dbname': dbName,
                'user': username,
                'password': password,
                'host': 'localhost',
                'port': server.local_bind_port
            }

            conn = psycopg.connect(**params)
            curs = conn.cursor()
            print("Database connection established")

            #DB work here....
            modify_database(curs, conn)

            conn.close()
        print("Database connection closed.")
    except:
        print("Connection failed")

if __name__ == '__main__':
    main()
